#!/usr/bin/php
<?php

    require_once __DIR__."/ProgressBar/Manager.php";
    require_once __DIR__."/ProgressBar/Registry.php";

    $addresses = explode("\n", file_get_contents(__DIR__."/hosts"));
    
    $progressBar = new \ProgressBar\Manager(0, count($addresses));
    
    file_put_contents(__DIR__."/ips.txt", "# Generated by getip at ".date('r')."\n");
    file_put_contents(__DIR__."/iptables.sh", "# Generated by getip at ".date('r')."\n");

    $ipsfile = fopen(__DIR__."/ips.txt", "a");
    $iptables = fopen(__DIR__."/iptables.sh", "a");

    foreach($addresses as $hostname) {

        $progressBar->advance();

        if ($hostname != "") {

            $ips = gethostbynamel($hostname);
            
            if ($ips != false) {
            
                fwrite($ipsfile, "# ".$hostname."\n");
                fwrite($iptables, "# ".$hostname."\n");
        
                foreach($ips as $ip) {
        
                    fwrite($ipsfile, $ip."\n");
                    fwrite($iptables, "IPTABLES -A INPUT -s ".$ip." -j DROP\n");
                    fwrite($iptables, "IPTABLES -A OUTPUT -s ".$ip." -j DROP\n");
        
                }
                
                fwrite($ipsfile, "\n");
                fwrite($iptables, "\n");
                
            } else {
            
                fwrite($ipsfile, "# Cant resolve ".$hostname."\n\n");
                fwrite($iptables, "# Cant resolve ".$hostname."\n\n");
            
            }
            
        }
        
    }
    
    fclose($ipsfile);
    fclose($iptables);

?>
